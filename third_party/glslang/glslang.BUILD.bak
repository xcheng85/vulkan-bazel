licenses(["notice"])

package(default_visibility = ["//visibility:public"])

include_files = [
    "include/glslang/Include/arrays.h",
    "include/glslang/Include/BaseTypes.h",
    "include/glslang/Include/Common.h",
    "include/glslang/Include/ConstantUnion.h",
    "include/glslang/Include/glslang_c_interface.h",
    "include/glslang/Include/glslang_c_shader_types.h",
    "include/glslang/Include/InfoSink.h",
    "include/glslang/Include/InitializeGlobals.h",
    "include/glslang/Include/intermediate.h",
    "include/glslang/Include/PoolAlloc.h",
    "include/glslang/Include/ResourceLimits.h",
    "include/glslang/Include/ShHandle.h",
    "include/glslang/Include/SpirvIntrinsics.h",
    "include/glslang/Include/Types.h",

    "include/glslang/Public/ResourceLimits.h",
    "include/glslang/Public/resource_limits_c.h",
    "include/glslang/Public/ShaderLang.h"
]

lib_files = [
    "lib/libGenericCodeGen.a",
    "lib/libglslang.a",
    "lib/libglslang-default-resource-limits.a",
    "lib/libHLSL.a",
    "lib/libMachineIndependent.a",
    "lib/libOGLCompiler.a",
    "lib/libOSDependent.a",
    "lib/libSPIRV-Tools-diff.a",
    "lib/libSPIRV-Tools-link.a",
    "lib/libSPIRV-Tools-lint.a",
    "lib/libSPIRV.a",
    "lib/libSPIRV-Tools.a",
    "lib/libSPIRV-Tools-opt.a",
    "lib/libSPIRV-Tools-reduce.a",
    "lib/libSPVRemapper.a"
]

genrule(
    name = "glslang-srcs",
    outs = include_files + lib_files,
    cmd = "\n".join([
        'export INSTALL_DIR=$$(pwd)/$(@D)',
        'echo $$(pwd)',
        'export TMP_DIR=$$(mktemp -d -t libglslang.XXXXX)',
        'mkdir -p $$TMP_DIR',
        'cp -R ../../../../../external/glslang/* $$TMP_DIR',
        'cd $$TMP_DIR',
        'mkdir build',
        'cd build',
        'cmake ../ -DCMAKE_INSTALL_PREFIX=$$INSTALL_DIR',
        'cmake -DCMAKE_BUILD_TYPE=Release -DCMAKE_INSTALL_PREFIX=$$INSTALL_DIR ../',
        'make -j4 install',
        'rm -rf $$TMP_DIR',
    ]),
)

cc_library(
    name = "glslang",
    srcs = lib_files,
    hdrs = include_files,
    includes=["include"],
    linkstatic = 1,
)